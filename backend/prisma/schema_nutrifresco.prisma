// Schema para NUTRIFRESCO - Marketplace de productos agrícolas locales
// Sistema basado en kilogramos, no en puntos ni precios

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MODELOS DE USUARIOS Y SUSCRIPCIONES
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  password  String
  role      String   @default("customer") // customer, producer, admin
  preferences Json   @default("{\"theme\": {}, \"notifications\": {}}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription Subscription?
  carts        Cart[]
  orders       Order[]
  producer     Producer?

  @@map("users")
}

enum SubscriptionPlan {
  BASIC    // 5 kg/mes - Solo frutas y verduras
  STANDARD // 8 kg/mes - Frutas, verduras + leguminosas, hierbas, snacks, café, chocolate
  PREMIUM  // 10 kg/mes - Todo lo anterior + proteínas
}

model Subscription {
  id            String          @id @default(cuid())
  userId        String          @unique
  plan          SubscriptionPlan @default(BASIC)
  limitInKg     Float           // Límite mensual en kilogramos
  usedKg        Float           @default(0) // Kilogramos usados en el mes actual
  renewalDate   DateTime        // Fecha de renovación mensual
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ============================================================================
// MODELOS DE PRODUCTORES Y PRODUCTOS
// ============================================================================

model Producer {
  id          String   @id @default(cuid())
  userId      String   @unique
  businessName String
  description String?
  location    String?  // Origen/ubicación del productor
  contactInfo Json?    @default("{}") // Teléfono, email, redes sociales
  verified    Boolean  @default(false) // Verificado por administradores
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  products    Product[]

  @@map("producers")
}

enum ProductCategory {
  FRUITS        // Frutas
  VEGETABLES    // Verduras y hortalizas
  LEGUMES       // Leguminosas
  HERBS         // Hierbas comestibles (chipilín, hierbamora, espinaca silvestre)
  SNACKS        // Snacks artesanales
  COFFEE        // Café local
  CHOCOLATE     // Chocolate artesanal
  PROTEINS      // Proteínas frescas (huevos, pollo, carne)
}

model Product {
  id            String          @id @default(cuid())
  producerId    String
  name          String
  description   String?
  category      ProductCategory
  weightInKg    Float           // Peso unitario en kilogramos
  available     Boolean         @default(true)
  stock         Int             @default(0) // Cantidad disponible
  image         String?
  origin        String?         // Origen específico del producto
  season        String?         // Temporada (ej: "Enero-Marzo")
  nutritionalInfo Json?          @default("{}")
  tags          Json            @default("[]")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  producer      Producer        @relation(fields: [producerId], references: [id], onDelete: Cascade)
  cartItems     CartItem[]
  orderItems    OrderItem[]

  @@map("products")
}

// ============================================================================
// MODELOS DE CARRITO Y PEDIDOS
// ============================================================================

model Cart {
  id            String   @id @default(cuid())
  userId        String
  totalWeightInKg Float  @default(0) // Peso total acumulado en kg
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         CartItem[]

  @@map("carts")
}

model CartItem {
  id            String   @id @default(cuid())
  cartId        String
  productId     String
  quantity      Int      @default(1)
  weightInKg    Float   // Peso total del item (product.weightInKg * quantity)
  name          String
  image         String?
  createdAt     DateTime @default(now())

  // Relations
  cart          Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model Order {
  id                String   @id @default(cuid())
  userId            String
  totalWeightInKg   Float    // Peso total del pedido
  status            String   @default("pending") // pending, confirmed, preparing, ready, delivered, cancelled
  deliveryAddress   String?
  deliveryDate      DateTime?
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User     @relation(fields: [userId], references: [id])
  items             OrderItem[]

  @@map("orders")
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId      String
  productId    String
  quantity     Int
  weightInKg   Float    // Peso total del item
  name         String
  image        String?
  producerName String?  // Snapshot del nombre del productor

  // Relations
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// ============================================================================
// MODELOS ADICIONALES (mantener si son útiles)
// ============================================================================

model Suggestion {
  id                String   @id @default(cuid())
  userId            String
  originalText      String
  extractedEntities Json     @default("[]")
  fuzzyCandidates   Json     @default("[]")
  confidence        Float    @default(0)
  status            String   @default("pending") // pending, approved, rejected
  adminNotes        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User     @relation(fields: [userId], references: [id])

  @@map("suggestions")
}

model ChatLog {
  id           String   @id @default(cuid())
  userId       String
  rawText      String
  parsedIntent String?
  parsedEntities Json?  @default("{}")
  matchedIds   Json?    @default("[]")
  confidence   Float?
  finalAction  String?
  userChoice   String?
  botResponse  Json?    @default("{}")
  createdAt    DateTime @default(now())

  // Relations
  user         User     @relation(fields: [userId], references: [id])

  @@map("chat_logs")
}

